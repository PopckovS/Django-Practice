PostgreSQL Часть 1
---
---

**Списки тем для изучения :**

1) Асинхронная репликация
2) Репликация
3) Репликация больная тема для MySQL
4) storage engine (подключаемых движков) 
5) рекурсивные запросы
6) наследование таблиц
7) Поддержка конкурентности реализована
   с использованием MVCC (Multiversion Concurrency Control)
8) совместимость с ACID
9) параллельность операций без блокировки при чтении
10) 

---
Разница между СУБД MySQL и PostgreSQL 
---

**ХРАНЕНИЕ ДАННЫХ**

Обе СУБД хранят данные на диске в спец отсортированных файлах, но различается 
только сам способ хранения.

MySQL - это реляционная база данных, в нутри которой есть реализауции нескольких
движков MyISAM, InnoDB, MEMORY, Berkeley DB, каждый движок работает по разному
с таблицами на чтение запись и прочее ...

Postgresql - это объектно реляционная база данных, и работате только с одними
единственным движком `storage engine` тоетсь каждая таблица представлена в виде 
обьекта, также предоставляются специальные обьектные функции для изменения этих 
таблиц-обьектов.

**СТАНДАРТ SQL**

Стандарт SQL разработан в 1986 году.

MySQL - стремится к простоте, и не реализует все возможности стансдартов SQL.

Postgresql - разрабатывается энтузиастами, и стремится к максималььному 
соответствию всем современным стандартам SQL какими бы сложными они не были. 

**ВОЗМОЖНОСТИ ОБРАБОТКИ**

MySQL - сервер MySQL получает запрос, выполняет его и отдает весь ответ клинту.

Postgresql - получает запрос, выполняет его и сохраняет на сервере самого Postgresql,
клиент получает указатель, этот указатель можно сохранить межжду сеансами обращения к
Postgresql, тоесть происходит кеширование полученых данных.

Postgresql - поддерживает наследование таблиц и рекурсивные запросы, поддерживается 
построение индексов сразу для нескольких столбцов таблицы, также можно создавать 
индексы сразу для нескольких столбцов таблицы, и при этом индексы будут разных 
типов, поддерживаются индексы типа:

1) hash
2) b-tree
3) GiST
4) SP-GiST для работы с городами
5) GIN для поиска по тексту
6) BRIN  
7) Bloom

**ПРОИЗВОДИТЕЛЬНОСТЬ**

MySQL - в большинстве случае используется таблицы с движком InnoDB, эта таблица
представляет из себя B-дерево с индексами, что позволяет по этим индексам быстро 
получать данные с диска, но ! MySQL будет быстрее Postgresql только при 
использовании первичного ключа

Postgresql - Вся заголовочная информация таблиц Postgresql находится в оперативной
памяти, а не на диске как у MySQL, записи таблицы сортируются по индексу и по этому
их можно быстро извлекать, в целом Postgresql работает быстрее.

**ТИПЫ ДАННЫХ**

MySQL - поддерживает стандартные типы данных.

Postgresql - типов данных в Postgresql больше и они более разнообразны, также
можно создавать свои собственные типы данных, тоетсь это расширяемая СУБД.

**РАЗРАБОТКА**

Оба проекта имеют открытый исходный код,

MySQL - разрабатывается компанией Oracle, от развития этой СУБД сделано множество 
форков и создано много разных реализаций, одна из которых MariaDB от оригиналььного
разработчика.

Postgresql - разработка началась в университете Беркли, сейчас развивается 
энтузиастами.

---
PostgreSQL Часть 2 
---

Существуют системные таблицы, смотреть их можно в:

      SELECT * FROM pg_catalog.pg_tables

**Установка :**

Установка PostgreSQL 
    
    sudo apt install postgresql postgresql-contrib
    
    psql --version
    psql (PostgreSQL) 10.16 (Ubuntu 10.16-0ubuntu0.18.04.1)

Помощь
    
    psql --help

Создать БД из файла SQL

    psql -f db.sql -U <user>

Подключение к уже существующей БД

    psql -d <DataBase> -U <user>

При попытке въода в систему берется роль самой учетной запись Linux и если в 
PG есть такая роль то под ней и происходит вход в PG.

После установки по дефолту создается специальная роль `postgres` обы зайти в 
систему под этой ролью есть 2 способа:

1) Можно переключиться на учетную запись `postgres` в самой системе и далее уже
   зайти в PG, делается это так


        sudo -i -u postgres

Увидем изменение учетной записи как `postgres@serg-pk` и уже тогда зайдем в PG

    psql

Чтобы выйти из PG используется спец команда:

    \q

2) Рекомендуемый способ, без переключения учетной записи, открываем psql от лица 
пользователя postgres используя sudo.
   

    sudo -u postgres psql

### Создание новой роли
Создать новую рольот лица сцперпользователя:

      sudo -u postgres createuser --interactive

Флаг --interactive спросит запросит имя новой роли и указание будет ли
это суперпользователь. Вводим имя нового пользователя и его роль.

      Enter name of role to add: user-1
      Shall the new role be a superuser? (y/n) y

### Создание новой базы данных
Создание новой БД

      sudo -u <user> createdb <DBname>

Показать все БД можно при помощи команды:

      \l

Создадим БД sammy и посмотрим на нее:

      sudo -u postgres createdb sammy

      \l      

      Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   
      -----------+----------+----------+-------------+-------------+-----------------------
       postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
       sammy     | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
       template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
                 |          |          |             |             | postgres=CTc/postgres
       template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
                 |          |          |             |             | postgres=CTc/postgres
   
Проверить к какой БД подключены в данный момент:

      \conninfo

      You are connected to database "postgres" as user "postgres" 
      via socket in "/var/run/postgresql" at port "5432"

Запуск PG и подключение к Базе Данных demo

      sudo -u postgres psql -d demo

Посмотреть все таблицы в Базе Данных

      \dt

---
Пользователи и Роли
---

Показать всех пользователей

    SELECT * FROM pg_user;

Показать все роли в БД

    SELECT * FROM pg_roles;

    или команду
    
    \du

---
 
Создать новую роль 

    CREATE ROLE new_role_name;

Удалить роль, и получить ошибку если такой роли не существует

    DROP ROLE role_name;

Удалить роль если такая роль существует, если ее нет то ошибки не будет 

    DROP ROLE IF EXISTS role_name;

---

Есть дамп в виде файла `sql` его требуется развернуть в БД из файла, сделать
это можно такой командой

    psql -U user -d db_name < dump_file.sql

Дать права пользователю на БД

    GRANT ALL PRIVILEGES ON DATABASE db_name to user_name;

Дать пользователю права супер пользователя

    ALTER USER user_name WITH SUPERUSER;

---

У нас есть ситуация, нам требуется сделать дам БД в виде `sql` файла, в самой БД
есть пользователи, и эти пользователи имеют права на различные действия, мы 
можем выгрузить дамп 2 способами, с сохранением прав и без.

Если права будут сохранены, то нам потребуется создать такого же пользователя в нашей
системе, и выполнять действия от его лица, такие как разворот дампа, нам потребуется
выполнять действия либо под тем же пользователем либо под универсальным пользователем 
`postgres`

Или можно выгрузить БД без сохранения прав пользователей.

Сделать дамп с сохранением прав пользователей

    pg_dump db_name > namebackup.sql

Сделать дамп без сохранения прав пользователей

    pg_dump --no-owner db_name > namebackup.sql


1) Подсказка `psql --help`

2) Исполнить SQL файл `psql -f db.sql -U <user>`

3) Подключение к уже сущест БД `psql -d <DataBase> -U <user>`

4) Переключить учетную запись на БД `sudo -i -u <user>`

5) Выйти из режима работы с PostgreSQL `\q`

6) Зайти в PG д ролью `sudo -u <user> psql`

7) Создание новой БД `sudo -u <user> createdb <DBname>`

8) Показать все БД `\l`

9) Показать под каким пользователем и к какой Бд подключены `\conninfo`

10) Посмотерть все таблицы текущей БД `\dt`

11) Подключаемся к PG под пользователем к нужной БД `sudo -u <user> psql -d <db>`

12) `\du`

13) Получить название полей таблицы в синтаксисом `pgsql` 

   ```
      SELECT column_name
      FROM INFORMATION_SCHEMA.COLUMNS
      WHERE TABLE_NAME = 'table_name'
      ;
   ```

14) Востановеление БД из файла `SQL`
   
```   
   SQL psql --host=127.0.0.1 --port 5432 --username postgres --dbname work_ngw_test --file backup_ngw.sql
```



